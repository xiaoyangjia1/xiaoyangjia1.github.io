<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>虚拟DOM 这次我可会讲了</title><meta name="description" content="Tate Yang的个人博客网站"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/yqx.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="
在vue是如何组合起来的文章中我们知道虚拟DOM就是以对象形式描述的DOM,也了解了啥时候调用patch算法进行虚拟Dom比对。
但之前都是用简化版的去实现，具体怎么比对，Vnode长啥样，我们这就来学学。
再补充一下，变化侦测只通知到组件级别。为了减小性能浪费，这也是产生Vnode的一个原因。
Vnode长啥样export interface VNode&amp;lt;
  HostNode = RendererNode,
  HostElement = RendererElement,
  ExtraProps = &amp;#123; [key: string]: any &amp;#125;
&gt; &amp;#123;
  __v_isVNode: true
  [ReactiveFlags.SKIP]: true
  type:.."><meta name="generator" content="Hexo 5.4.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Tate Yang's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">虚拟DOM 这次我可会讲了</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Vnode%E9%95%BF%E5%95%A5%E6%A0%B7"><span class="toc-text">Vnode长啥样</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vode%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">Vode的类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#patch"><span class="toc-text">patch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#patch%E4%BD%9C%E7%94%A8"><span class="toc-text">patch作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9"><span class="toc-text">新增节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-text">删除节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E8%8A%82%E7%82%B9"><span class="toc-text">更新节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9"><span class="toc-text">静态节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E6%9C%89%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7"><span class="toc-text">新虚拟节点有文本属性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E8%99%9A%E6%8B%9F%E8%8A%82%E7%82%B9%E6%97%A0%E6%96%87%E6%9C%AC%E5%B1%9E%E6%80%A7"><span class="toc-text">新虚拟节点无文本属性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5-diff%E7%AE%97%E6%B3%95"><span class="toc-text">更新策略(diff算法)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-text">创建子节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%A7%BB%E5%8A%A8%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-text">移动子节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-text">删除子节点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-text">优化策略</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%8F%91%E7%8E%B0%E5%93%AA%E4%BA%9B%E8%8A%82%E7%82%B9%E6%98%AF%E6%9C%AA%E5%A4%84%E7%90%86%E7%9A%84"><span class="toc-text">如何发现哪些节点是未处理的</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/vue3"><i class="tag post-item-tag">vue3</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">虚拟DOM 这次我可会讲了</h1><time class="has-text-grey" datetime="2021-12-18T12:31:01.000Z">2021-12-18</time><article class="mt-2 post-content"><p><img src="https://s2.loli.net/2021/12/18/FndVgrY5BjDbtem.jpg" alt="微信图片_20211218203818.jpg"></p>
<p>在<strong>vue是如何组合起来的</strong>文章中我们知道虚拟DOM就是以对象形式描述的DOM,也了解了啥时候调用patch算法进行虚拟Dom比对。</p>
<p>但之前都是用简化版的去实现，具体怎么比对，<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/blob/master/packages/runtime-core/src/vnode.ts">Vnode</a>长啥样，我们这就来学学。</p>
<p>再补充一下，变化侦测只通知到组件级别。为了减小性能浪费，这也是产生Vnode的一个原因。</p>
<h2 id="Vnode长啥样"><a href="#Vnode长啥样" class="headerlink" title="Vnode长啥样"></a>Vnode长啥样</h2><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span><span class="token operator">&lt;</span>
  HostNode <span class="token operator">=</span> RendererNode<span class="token punctuation">,</span>
  HostElement <span class="token operator">=</span> RendererElement<span class="token punctuation">,</span>
  ExtraProps <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">&#125;</span>
<span class="token operator">></span> <span class="token punctuation">&#123;</span>
  __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">SKIP</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span>
  type<span class="token operator">:</span> VNodeTypes
  props<span class="token operator">:</span> <span class="token punctuation">(</span>VNodeProps <span class="token operator">&amp;</span> ExtraProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  key<span class="token operator">:</span> string <span class="token operator">|</span> number <span class="token operator">|</span> symbol <span class="token operator">|</span> <span class="token keyword">null</span>
  ref<span class="token operator">:</span> VNodeNormalizedRef <span class="token operator">|</span> <span class="token keyword">null</span>
  scopeId<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span>
  slotScopeIds<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  children<span class="token operator">:</span> VNodeNormalizedChildren
  component<span class="token operator">:</span> ComponentInternalInstance <span class="token operator">|</span> <span class="token keyword">null</span>
  dirs<span class="token operator">:</span> DirectiveBinding<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  transition<span class="token operator">:</span> TransitionHooks<span class="token operator">&lt;</span>HostElement<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token comment">// DOM</span>
  el<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span>
  anchor<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// fragment anchor</span>
  target<span class="token operator">:</span> HostElement <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// teleport target</span>
  targetAnchor<span class="token operator">:</span> HostNode <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// teleport target anchor</span>
  staticCount<span class="token operator">:</span> number
  suspense<span class="token operator">:</span> SuspenseBoundary <span class="token operator">|</span> <span class="token keyword">null</span>
  ssContent<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span>
  ssFallback<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span>
  shapeFlag<span class="token operator">:</span> number
  patchFlag<span class="token operator">:</span> number
  dynamicProps<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  dynamicChildren<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span>
  appContext<span class="token operator">:</span> AppContext <span class="token operator">|</span> <span class="token keyword">null</span>
  memo<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span>
  isCompatRoot<span class="token operator">?</span><span class="token operator">:</span> <span class="token boolean">true</span>
  ce<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">instance<span class="token operator">:</span> ComponentInternalInstance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span>
<span class="token punctuation">&#125;</span>
</code></pre>

<p>根据Vnode的定义，可见其就是一个普通的对象。</p>
<h2 id="Vode的类型"><a href="#Vode的类型" class="headerlink" title="Vode的类型"></a>Vode的类型</h2><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> type VNodeTypes <span class="token operator">=</span>
  <span class="token operator">|</span> string
  <span class="token operator">|</span> VNode
  <span class="token operator">|</span> Component
  <span class="token operator">|</span> <span class="token keyword">typeof</span> Text
  <span class="token operator">|</span> <span class="token keyword">typeof</span> Static
  <span class="token operator">|</span> <span class="token keyword">typeof</span> Comment
  <span class="token operator">|</span> <span class="token keyword">typeof</span> Fragment
  <span class="token operator">|</span> <span class="token keyword">typeof</span> TeleportImpl
  <span class="token operator">|</span> <span class="token keyword">typeof</span> SuspenseImpl</code></pre>

<p>不同类型的Vnode之间其实只是有效属性不同，创建Vnode实例时，无效的属性会有默认赋值</p>
<p>可以创建不同类型的Vnode</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建文本节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTextVNode</span><span class="token punctuation">(</span>text<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">,</span> flag<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Text<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 创建静态节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createStaticVNode</span><span class="token punctuation">(</span>
  <span class="token parameter">content<span class="token operator">:</span> string<span class="token punctuation">,</span>
  numberOfNodes<span class="token operator">:</span> number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Static<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
  vnode<span class="token punctuation">.</span>staticCount <span class="token operator">=</span> numberOfNodes
  <span class="token keyword">return</span> vnode
<span class="token punctuation">&#125;</span>
<span class="token comment">// 创建注释节点</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createCommentVNode</span><span class="token punctuation">(</span>
  text<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span>
  asBlock<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> asBlock
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token function">openBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">createBlock</span><span class="token punctuation">(</span>Comment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">createVNode</span><span class="token punctuation">(</span>Comment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>终于到虚拟Dom的核心部分了</p>
<h3 id="patch作用"><a href="#patch作用" class="headerlink" title="patch作用"></a>patch作用</h3><p>对比两个Vnode之间的差异只是patch的一部分，这是手段，不是目的。patch是在现有的DOM上进行修改达到渲染视图的目的。所以要做三件事</p>
<ul>
<li>创建新增的节点</li>
<li>删除废弃的节点</li>
<li>修改更新的节点</li>
</ul>
<p>看看源码</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> patch<span class="token operator">:</span> <span class="token function-variable function">PatchFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token parameter">n1<span class="token punctuation">,</span>
    n2<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    anchor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentComponent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parentSuspense <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    isSVG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    slotScopeIds <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    optimized <span class="token operator">=</span> __DEV__ <span class="token operator">&amp;&amp;</span> isHmrUpdating <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>n2<span class="token punctuation">.</span>dynamicChildren</span>
  <span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">===</span> n2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// patching &amp; not same type, unmount old tree</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      anchor <span class="token operator">=</span> <span class="token function">getNextHostNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
      <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      n1 <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>patchFlag <span class="token operator">===</span> PatchFlags<span class="token punctuation">.</span><span class="token constant">BAIL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      optimized <span class="token operator">=</span> <span class="token boolean">false</span>
      n2<span class="token punctuation">.</span>dynamicChildren <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> type<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> shapeFlag <span class="token punctuation">&#125;</span> <span class="token operator">=</span> n2
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> Text<span class="token operator">:</span>
        <span class="token function">processText</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Comment<span class="token operator">:</span>
        <span class="token function">processCommentNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Static<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">mountStaticNode</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">patchStaticNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> isSVG<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> Fragment<span class="token operator">:</span>
        <span class="token function">processFragment</span><span class="token punctuation">(</span>
          n1<span class="token punctuation">,</span>
          n2<span class="token punctuation">,</span>
          container<span class="token punctuation">,</span>
          anchor<span class="token punctuation">,</span>
          parentComponent<span class="token punctuation">,</span>
          parentSuspense<span class="token punctuation">,</span>
          isSVG<span class="token punctuation">,</span>
          slotScopeIds<span class="token punctuation">,</span>
          optimized
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">processElement</span><span class="token punctuation">(</span>
            n1<span class="token punctuation">,</span>
            n2<span class="token punctuation">,</span>
            container<span class="token punctuation">,</span>
            anchor<span class="token punctuation">,</span>
            parentComponent<span class="token punctuation">,</span>
            parentSuspense<span class="token punctuation">,</span>
            isSVG<span class="token punctuation">,</span>
            slotScopeIds<span class="token punctuation">,</span>
            optimized
          <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">processComponent</span><span class="token punctuation">(</span>
            n1<span class="token punctuation">,</span>
            n2<span class="token punctuation">,</span>
            container<span class="token punctuation">,</span>
            anchor<span class="token punctuation">,</span>
            parentComponent<span class="token punctuation">,</span>
            parentSuspense<span class="token punctuation">,</span>
            isSVG<span class="token punctuation">,</span>
            slotScopeIds<span class="token punctuation">,</span>
            optimized
          <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TELEPORT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span>type <span class="token keyword">as</span> <span class="token keyword">typeof</span> TeleportImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
            n1 <span class="token keyword">as</span> TeleportVNode<span class="token punctuation">,</span>
            n2 <span class="token keyword">as</span> TeleportVNode<span class="token punctuation">,</span>
            container<span class="token punctuation">,</span>
            anchor<span class="token punctuation">,</span>
            parentComponent<span class="token punctuation">,</span>
            parentSuspense<span class="token punctuation">,</span>
            isSVG<span class="token punctuation">,</span>
            slotScopeIds<span class="token punctuation">,</span>
            optimized<span class="token punctuation">,</span>
            internals
          <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__FEATURE_SUSPENSE__ <span class="token operator">&amp;&amp;</span> shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">SUSPENSE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token punctuation">;</span><span class="token punctuation">(</span>type <span class="token keyword">as</span> <span class="token keyword">typeof</span> SuspenseImpl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
            n1<span class="token punctuation">,</span>
            n2<span class="token punctuation">,</span>
            container<span class="token punctuation">,</span>
            anchor<span class="token punctuation">,</span>
            parentComponent<span class="token punctuation">,</span>
            parentSuspense<span class="token punctuation">,</span>
            isSVG<span class="token punctuation">,</span>
            slotScopeIds<span class="token punctuation">,</span>
            optimized<span class="token punctuation">,</span>
            internals
          <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Invalid VNode type:'</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">typeof</span> type<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// set ref</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> parentComponent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">setRef</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> n1 <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>ref<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> n2 <span class="token operator">||</span> n1<span class="token punctuation">,</span> <span class="token operator">!</span>n2<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span></code></pre>



<h4 id="新增节点"><a href="#新增节点" class="headerlink" title="新增节点"></a>新增节点</h4><p>这通常发生在首次渲染中。因为在首次渲染中，oldVnode不存在任何节点。</p>
<p>还有一种情况是当oldVnode和vnode完全不是同一个节点时，vnode是一个全新的节点，而oldNode是废弃的节点。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// patching &amp; not same type, unmount old tree</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  anchor <span class="token operator">=</span> <span class="token function">getNextHostNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
  <span class="token function">unmount</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentSuspense<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  n1 <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">&#125;</span>
</code></pre>

<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> processText<span class="token operator">:</span> <span class="token function-variable function">ProcessTextOrCommentFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">hostInsert</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateText</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        anchor
      <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token operator">!==</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">hostSetText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> string<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span></code></pre>



<h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><p>在vnode中不存在的节点都是废弃的，需要删除</p>
<h4 id="更新节点"><a href="#更新节点" class="headerlink" title="更新节点"></a>更新节点</h4><h5 id="静态节点"><a href="#静态节点" class="headerlink" title="静态节点"></a>静态节点</h5><p>静态节点不会因状态的变化而发生变化，比对时可跳过更新操作</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">patchStaticNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span>
  container<span class="token operator">:</span> RendererElement<span class="token punctuation">,</span>
  isSVG<span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// static nodes are only patched during dev for HMR</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token operator">!==</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> anchor <span class="token operator">=</span> <span class="token function">hostNextSibling</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>anchor<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token comment">// remove existing</span>
    <span class="token function">removeStaticNode</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>
    <span class="token comment">// insert new</span>
    <span class="token punctuation">;</span><span class="token punctuation">[</span>n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>anchor<span class="token punctuation">]</span> <span class="token operator">=</span> hostInsertStaticContent<span class="token operator">!</span><span class="token punctuation">(</span>
      n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> string<span class="token punctuation">,</span>
      container<span class="token punctuation">,</span>
      anchor<span class="token punctuation">,</span>
      isSVG
    <span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el
    n2<span class="token punctuation">.</span>anchor <span class="token operator">=</span> n1<span class="token punctuation">.</span>anchor
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="新虚拟节点有文本属性"><a href="#新虚拟节点有文本属性" class="headerlink" title="新虚拟节点有文本属性"></a>新虚拟节点有文本属性</h5><p>当两个虚拟节点都不是静态节点时且有不同属性时，要以新的为准，如果新虚拟节点有文本属性可直接替换</p>
<h5 id="新虚拟节点无文本属性"><a href="#新虚拟节点无文本属性" class="headerlink" title="新虚拟节点无文本属性"></a>新虚拟节点无文本属性</h5><p>如果新虚拟节点无文本属性，两个都有children还要进行更细致的比对，若新节点无children,说明是空节点，将旧节点也变为空节点。</p>
<h5 id="更新策略-diff算法"><a href="#更新策略-diff算法" class="headerlink" title="更新策略(diff算法)"></a>更新策略(diff算法)</h5><h6 id="创建子节点"><a href="#创建子节点" class="headerlink" title="创建子节点"></a>创建子节点</h6><p>当在oldChildren中没有找到与本次循环所指向的新子节点相同的节点，需要执行创建节点操作。</p>
<p>将创建的节点插入到oldChildren所以未处理的节点前面</p>
<h6 id="移动子节点"><a href="#移动子节点" class="headerlink" title="移动子节点"></a>移动子节点</h6><p>当比对发现是同一节点但位置不同时，需要移动到所有未处理的节点前面</p>
<h6 id="删除子节点"><a href="#删除子节点" class="headerlink" title="删除子节点"></a>删除子节点</h6><p>遍历后删除所有标记未处理的节点</p>
<h6 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h6><p>通常情况下，并不是所有子节点的位置都会发生移动，所以可以采用一下4种查找方式进行优化,注意查找的范围都是在未处理数组的前面</p>
<ul>
<li><p>新前与旧前</p>
</li>
<li><p>新后与旧后</p>
</li>
<li><p>新后与旧前</p>
</li>
<li><p>新前与旧后</p>
</li>
</ul>
<p>如果以上4种方式都不行再采用循环的方式</p>
<h6 id="如何发现哪些节点是未处理的"><a href="#如何发现哪些节点是未处理的" class="headerlink" title="如何发现哪些节点是未处理的"></a>如何发现哪些节点是未处理的</h6><p>建立四个变量：oldStartIdx、oldEndInx、newStartInx、newEndInx</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartInx <span class="token operator">&lt;=</span> oldEndInx <span class="token operator">&amp;&amp;</span> newStartInx <span class="token operator">&lt;=</span> newEndInx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 更新操作</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newStartInx <span class="token operator">&lt;=</span> newEndInx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 范围内都是新增节点</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartInx <span class="token operator">&lt;=</span> oldEndInx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 范围内都是废弃节点</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>我觉得这哥们讲的挺好的</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/372644149">从createApp开始的首屏渲染</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/372671989">Vue3源码分析</a></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/12/19/%E5%93%8D%E5%BA%94%E5%BC%8F%E8%AE%A1%E7%AE%97%E4%B8%8E%E4%BE%A6%E5%90%AC/" title="响应式计算与侦听"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: 响应式计算与侦听</span></a><a class="button is-default" href="/2021/12/17/%E8%81%8A%E8%81%8AnextTick/" title="聊聊nextTick"><span class="has-text-weight-semibold">Next: 聊聊nextTick</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="xiaoyangjia1/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xiaoyangjia1"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Tate Yang 2021</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>